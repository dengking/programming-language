



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Project documentation with Markdown.">
      
      
        <link rel="canonical" href="https://dengking.github.io/programming-language/Python/Language/Developer's-guide/25-Design-of-CPython's-Compiler/02-cpython-PEG/Guido-van-Rossum-PEG-parser-series/02-Building-a-PEG-Parser/">
      
      
        <meta name="author" content="DengKing">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>[**Building** a **PEG** **Parser**](https://medium.com/@gvanrossum_83706/building-a-peg-parser-d4869b5958fb) - programming-language</title>
      
    
    
      <link rel="stylesheet" href="../../../../../../../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../../../../../../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../../../../../css/extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-27795084-5", "mkdocs.org")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#building-a-peg-parser" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://dengking.github.io/programming-language" title="programming-language" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              programming-language
            </span>
            <span class="md-header-nav__topic">
              
                [**Building** a **PEG** **Parser**](https://medium.com/@gvanrossum_83706/building-a-peg-parser-d4869b5958fb)
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/dengking/programming-language" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://dengking.github.io/programming-language" title="programming-language" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    programming-language
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/dengking/programming-language" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../../../../Programming-language/" title="Programming-language" class="md-nav__link">
      Programming-language
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../../../../Common/" title="Common" class="md-nav__link">
      Common
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Theory
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Theory
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      Type-system
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        Type-system
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Type-system/Type-system/" title="Type-system" class="md-nav__link">
      Type-system
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Type-system/Type-safety/" title="Type-safety" class="md-nav__link">
      Type-safety
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Type-system/Static-vs-dynamic-typing/" title="Static-vs-dynamic-typing" class="md-nav__link">
      Static-vs-dynamic-typing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      Programming-paradigm
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        Programming-paradigm
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Programming-paradigm/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Programming-paradigm/Programming-paradigm/" title="Programming-paradigm" class="md-nav__link">
      Programming-paradigm
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3-3" type="checkbox" id="nav-4-3-3">
    
    <label class="md-nav__link" for="nav-4-3-3">
      Object-oriented-programming
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-3-3">
        Object-oriented-programming
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Programming-paradigm/Object-oriented-programming/Object-oriented-programming/" title="Object-oriented-programming" class="md-nav__link">
      Object-oriented-programming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3-3-2" type="checkbox" id="nav-4-3-3-2">
    
    <label class="md-nav__link" for="nav-4-3-3-2">
      Thinking-in-java
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-4-3-3-2">
        Thinking-in-java
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Programming-paradigm/Object-oriented-programming/Thinking-in-java/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Programming-paradigm/Object-oriented-programming/Thinking-in-java/Introduction-to-Objects/" title="Introduction-to-Objects" class="md-nav__link">
      Introduction-to-Objects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Programming-paradigm/Object-oriented-programming/Thinking-in-java/Everything-is-an-object/" title="Everything-is-an-object" class="md-nav__link">
      Everything-is-an-object
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../Theory/Programming-paradigm/Object-oriented-programming/Glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      Language
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        Language
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1-1" type="checkbox" id="nav-5-1-1">
    
    <label class="md-nav__link" for="nav-5-1-1">
      Language-reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-1-1">
        Language-reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../Language-reference/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1-2" type="checkbox" id="nav-5-1-2">
    
    <label class="md-nav__link" for="nav-5-1-2">
      Developer's-guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-1-2">
        Developer's-guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Library-Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Library-Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2-1" type="checkbox" id="nav-5-2-1">
    
    <label class="md-nav__link" for="nav-5-2-1">
      Build-in-function
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-2-1">
        Build-in-function
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Library-Reference/build-in-function/summary-of-python-build-in-function/" title="Summary-of-python-build-in-function" class="md-nav__link">
      Summary-of-python-build-in-function
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2-1-2" type="checkbox" id="nav-5-2-1-2">
    
    <label class="md-nav__link" for="nav-5-2-1-2">
      Hash
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-5-2-1-2">
        Hash
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Library-Reference/build-in-function/hash/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Philosophy
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Philosophy
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Philosophy/The-Zen-of-Python/" title="The-Zen-of-Python" class="md-nav__link">
      The-Zen-of-Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Style-guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Style-guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Style-guide/Style-Guide-for-Python-Code/" title="Style-Guide-for-Python-Code" class="md-nav__link">
      Style-Guide-for-Python-Code
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      Paradigm
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        Paradigm
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Paradigm/Functional-programming/" title="Functional-programming" class="md-nav__link">
      Functional-programming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5-2" type="checkbox" id="nav-5-5-2">
    
    <label class="md-nav__link" for="nav-5-5-2">
      Meta-programming
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-5-2">
        Meta-programming
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5-2-1" type="checkbox" id="nav-5-5-2-1">
    
    <label class="md-nav__link" for="nav-5-5-2-1">
      Reflective
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-5-5-2-1">
        Reflective
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Paradigm/Meta-programming/Reflective/Python-reflection/" title="Python-reflection" class="md-nav__link">
      Python-reflection
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-6" type="checkbox" id="nav-5-6">
    
    <label class="md-nav__link" for="nav-5-6">
      How-to
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-6">
        How-to
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-6-1" type="checkbox" id="nav-5-6-1">
    
    <label class="md-nav__link" for="nav-5-6-1">
      Lazy-import
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-6-1">
        Lazy-import
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../How-to/Lazy-import/Lazy-importing/" title="Lazy-importing" class="md-nav__link">
      Lazy-importing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7" type="checkbox" id="nav-5-7">
    
    <label class="md-nav__link" for="nav-5-7">
      Software
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-7">
        Software
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Software/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-8" type="checkbox" id="nav-5-8">
    
    <label class="md-nav__link" for="nav-5-8">
      Glossary
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-8">
        Glossary
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Glossary/Abstract-base-class/" title="Abstract-base-class" class="md-nav__link">
      Abstract-base-class
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../Glossary/Argument-and-parameter/" title="Argument-and-parameter" class="md-nav__link">
      Argument-and-parameter
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      C++
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        C++
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">
    
    <label class="md-nav__link" for="nav-6-1">
      Language
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        Language
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1-1" type="checkbox" id="nav-6-1-1">
    
    <label class="md-nav__link" for="nav-6-1-1">
      Language-reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-6-1-1">
        Language-reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../C++/Language/Language-reference/" title="index" class="md-nav__link">
      index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1-2" type="checkbox" id="nav-6-1-2">
    
    <label class="md-nav__link" for="nav-6-1-2">
      Idiom
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-6-1-2">
        Idiom
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../C++/Language/Idiom/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2">
    
    <label class="md-nav__link" for="nav-6-2">
      Pattern
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        Pattern
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../C++/Pattern/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-3" type="checkbox" id="nav-6-3">
    
    <label class="md-nav__link" for="nav-6-3">
      Paradigm
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-3">
        Paradigm
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../../../C++/Paradigm/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="building-a-peg-parser"><a href="https://medium.com/@gvanrossum_83706/building-a-peg-parser-d4869b5958fb"><strong>Building</strong> a <strong>PEG</strong> <strong>Parser</strong></a></h1>
<p>Inspired by only a partial understanding of <strong>PEG</strong> parsing I decided to build one. The result may not be a great general-purpose <strong>PEG</strong> <strong>parser</strong> generator — there are already many of those (e.g. <a href="https://pypi.org/project/TatSu/">TatSu</a> is written in Python and generates Python code) — but it was a good way to learn about <strong>PEG</strong>, and it furthers my goal of replacing CPython’s <strong>parser</strong> with one built from a <strong>PEG</strong> grammar.</p>
<p>[This is part 2 of my <strong>PEG</strong> series. See the <a href="https://medium.com/@gvanrossum_83706/peg-parsing-series-de5d41b2ed60?sk=0a7ce9003b13aae8126a4a23812eb035">Series Overview</a> for the rest.]</p>
<p>In this section I lay the groundwork for understanding how the generated <strong>parser</strong> works, by showing a simple hand-written <strong>parser</strong>.</p>
<p>(By the way, as an experiment, I’m not sprinkling links all over my writings. If there’s something you don’t understand, just Google it. :-)</p>
<p>The most common way of <strong>PEG</strong> parsing uses a recursive descent <strong>parser</strong> with unlimited <strong>backtracking</strong>. Take the toy grammar from last week’s article:</p>
<div class="highlight"><pre><span></span>statement: assignment | expr | if_statement
expr: expr &#39;+&#39; term | expr &#39;-&#39; term | term
term: term &#39;*&#39; atom | term &#39;/&#39; atom | atom
atom: NAME | NUMBER | &#39;(&#39; expr &#39;)&#39;
assignment: target &#39;=&#39; expr
target: NAME
if_statement: &#39;if&#39; expr &#39;:&#39; statement
</pre></div>

<p>A super-abstract recursive descent <strong>parser</strong> for this language would define a function for each symbol that tries to call the functions corresponding to the alternatives. For example, for <code>statement</code> we’d have this function:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">statement</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">assignment</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">expr</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">if_statement</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</pre></div>

<p>Of course this is too simplistic: it leaves out essential details about the <strong>parser</strong>’s input and output.</p>
<p>Let’s start with the input side. Classic parsers use a separate <strong>tokenizer</strong> which breaks the input (a text file or string) into a series of <strong>tokens</strong>, such as keywords, identifiers (names), numbers and operators. <strong>PEG</strong> parsers (like other modern parsers such as ANTLR) often unify tokenizing and parsing, but for my project I chose to keep the separate <strong>tokenizer</strong>.</p>
<p>Tokenizing Python is complicated enough that I don’t want to reimplement it using <strong>PEG</strong>’s formalism. For example, you have to keep track of <strong>indentation</strong> (this requires a stack inside the tokenizer), and the handling of newlines in Python is interesting (they are significant except inside matching brackets). The many types of string quotes also cause some complexity. In short, I have no beef with Python’s existing tokenizer, so I want to keep it. (Aside: CPython has two tokenizers —an internal one used by the <strong>parser</strong>, written in C, and the standard library one, which is a faithful reimplementation in pure Python. This is helpful for my project.)</p>
<p>Classic tokenizers typically have a simple interface whereby you call a function, e.g. <code>get_token()</code>, which returns the next token in the input, consuming the input a few characters at a time. The <code>tokenize</code> module simplifies this even further: its basic API is a <strong>generator</strong> which yields one token at a time. Each token is a <code>TypeInfo</code> object which has several fields, the most important ones of which indicate the <em>type</em> of the token (e.g. <code>NAME</code>, <code>NUMBER</code>, <code>STRING</code>), and its <em>string</em> value, meaning the string of characters comprising the token (e.g. <code>abc</code>, <code>42</code>, or <code>"hello world"</code>). There are also additional fields that give the <strong>coordinates</strong> of the token in the input file, which is useful for error reporting.</p>
<p>A special token type is<code>ENDMARKER</code>, which indicates that the end of the input file has been reached. The generator terminates if you ignore this and try to get the next token.</p>
<p>But I digress. How do we implement <strong>unlimited backtracking</strong>? Backtracking requires you to be able to remember a position in the source code and re-parse from that point. The tokenizer API doesn’t allow us to reset its input pointer, but it’s easy to capture the stream of tokens in an array and replay it from there, so that’s what we do. (You could also do this using <code>itertools.tee()</code>, but based on warnings in the docs that’s probably less efficient in our case.)</p>
<p>I suppose you could just first tokenize the entire input into a Python list and then use that as the <strong>parser</strong> input, but that would mean if there’s an invalid token near the end of the file (such as a string with a missing closing quote) and there’s also a syntax error earlier in the file, you would get an error message about the bad token first. I would find that a poor user experience, since the syntax error could actually be the root cause for the bad string. So my design tokenizes on demand, and the list becomes a lazy list.</p>
<p>The basic API is very simple. The <code>Tokenizer</code> object encapsulates the array of tokens and the position in that array. It has three basic methods:</p>
<ul>
<li><code>get_token()</code> returns the next token, advancing the position in the array (reading another token from the source if we’re at the end of the array);</li>
<li><code>mark()</code> returns the current <strong>position</strong> in the array;</li>
<li><code>reset(pos)</code> sets the position in the array (the argument <em>must</em> be something you got from <code>mark()</code>).</li>
</ul>
<p>We add one convenience function, <code>peek_token()</code> which returns the next token without advancing the position.</p>
<p>Here, then, is the core of the <code>Tokenizer</code> class:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tokenizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokengen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call with tokenize.generate_tokens(...).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokengen</span> <span class="o">=</span> <span class="n">tokengen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">mark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peek_token</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">token</span>
    <span class="k">def</span> <span class="nf">peek_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokengen</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span>
</pre></div>

<p>Now, there are various things still missing (and the names of the methods and instance variables should really start with an underscore), but this will do as a sketch of the <code>Tokenizer</code> API.</p>
<p>The <strong>parser</strong> also needs to become a class, so that <code>statement()</code>, <code>expr()</code> and so on can become methods. The tokenizer becomes an instance variable, but we don’t want the parsing methods to call <code>get_token()</code> directly — instead, we give the <code>**Parser**</code> class an <code>expect()</code> method which can succeed or fail just like a parsing method. The argument to <code>expect()</code> is the expected token — either a string (like <code>"+"</code>) or a token type (like <code>NAME</code>). I’ll get to the return type after discussing the <strong>parser</strong>’s output.</p>
<p>In my first sketch of the <strong>parser</strong>, the parsing functions just returned <code>True</code> or <code>False</code>. That’s fine for theoretical computer science (where the question a <strong>parser</strong> answers is “is this a valid string in the language?”) but not when you’re <strong>building</strong> a <strong>parser</strong> — instead, we want the <strong>parser</strong> to create an AST. So let’s just arrange it so that each parsing method returns a <code>Node</code> object on success, or <code>None</code> on failure.</p>
<p>The <code>Node</code> class can be super simple:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">children</span>
</pre></div>

<p>Here, <code>type</code> indicates what kind of <strong>AST node</strong> this is (e.g. an <code>"add"</code> node or an <code>"if"</code> node), and <code>children</code> is a list of nodes and tokens (instances of <code>TokenInfo</code>). This is enough for a compiler to generate code or do other analysis such as linting or static type checking, although in the future I’d like to change the way we represent the AST.</p>
<p>To fit into this scheme, the <code>expect()</code> method returns a <code>TokenInfo</code> object on success, and <code>None</code> on failure. To support backtracking, I wrap the tokenizer’s <code>mark()</code> and <code>reset()</code> methods (no API change here). Here then is the infrastructure for the <code>**Parser**</code> class:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="k">def</span> <span class="nf">mark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">mark</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">peek_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">arg</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>

<p>Again, I’ve left out some details, but this works.</p>
<p>At this point I need to introduce an important requirement for parsing methods: a parsing method either returns a <code>Node</code>, positioning the tokenizer after the last token of the grammar rule it recognized; or it returns <code>None</code>, <em>and then it leaves the tokenizer position unchanged</em>. If a parsing method reads several tokens and then decides to fail, it <em>must</em> restore the tokenizer’s position. That’s what <code>mark()</code> and <code>reset()</code> are for. Note that <code>expect()</code> also follows this rule.</p>
<p>So here’s a sketch of the actual <strong>parser</strong>. Note that I am using Python 3.8’s walrus operator (<code>:=</code>):</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ToyParser</span><span class="p">(</span><span class="n">Parser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">statement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">e</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">e</span>
        <span class="k">if</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_statement</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">():</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">op</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">e</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">e</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">e</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">e</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">t</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Very similar...</span>
    <span class="k">def</span> <span class="nf">atom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">NAME</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">token</span>
        <span class="k">if</span> <span class="n">token</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">NUMBER</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">token</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e</span> <span class="p">:</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>

<p>I’ve left some parsing methods as exercises for the reader — this is really more to give a flavor of what such a <strong>parser</strong> looks like, and eventually we’ll generate code like this automatically from the grammar. Constants like <code>NAME</code>and <code>NUMBER</code> are imported from the <code>token</code> module in the standard library. (This ties us further to Python tokenization; there are ways around this that we should explore if we want to make a more general <strong>PEG</strong> <strong>parser</strong> generator.)</p>
<p>Also note that I cheated a bit: <code>expr</code> is left-recursive, but I made the <strong>parser</strong> *right-*recursive, because recursive-descent parsers don’t work with left-recursive grammar rules. There’s a fix for this, but it’s still the topic of some academic research and I’d like to present it separately. Just realize that this version doesn’t correspond 100% with the toy grammar.</p>
<p>The key things I want you to get at this point are:</p>
<ul>
<li>Grammar rules correspond to <strong>parser</strong> methods, and when a grammar rule references another grammar rule, its parsing method calls the other rule’s parsing method.</li>
<li>When multiple items make up an alternative, the parsing method calls the corresponding methods one after the other.</li>
<li>When a grammar rule references a token, its parsing method calls <code>expect()</code>.</li>
<li>When a parsing method successfully recognizes its grammar rule at the given input position, it returns a corresponding AST node; when it fails to recognize its grammar rule, it returns <code>None</code>.</li>
<li>Parsing methods must explicitly reset the tokenizer position when they abandon a parse after having consumed one or more tokens (directly, or indirectly by calling another parsing method that succeeded). This applies when abandoning one alternative to try the next, and also when abandoning the parse altogether.</li>
</ul>
<p>If all parsing methods abide by these rules, it’s not necessary to use <code>mark()</code> and <code>reset()</code> around a single parsing method. You can prove this using induction.</p>
<p>As an aside, it’s tempting to try to get rid of the explicit <code>mark()</code> and <code>reset()</code> calls by using a context manager and a <code>with</code> statement, but this doesn’t work: the <code>reset()</code> call shouldn’t be called upon success! As a further fix you could try to use exceptions for control flow, so the context manager knows whether to reset the tokenizer (I think TatSu does something like this). For example, you could arrange for this to work:</p>
<div class="highlight"><pre><span></span>    def statement(self):
        with self.alt():
            return self.assignment()
        with self.alt():
            return self.expr()
        with self.alt():
            return self.if_statement()
        raise ParsingFailure
</pre></div>

<p>In particular, the little ladder of <code>if</code> statements in <code>atom()</code> for recognizing a parenthesized expression could become:</p>
<div class="highlight"><pre><span></span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">e</span>
</pre></div>

<p>But I find this too “magical” — when reading such code you must stay aware that each parsing method (and <code>expect()</code>) may raise an exception, and that this exception is caught and ignored by the context manager in the <code>with</code> statement. That’s pretty unusual, although definitely supported (by returning true from <code>__exit__</code>). Also, my ultimate goal is to generate C, not Python, and in C there’s no <code>with</code> statement to alter the control flow.</p>
<p>Anyway, here are some topics for future installments:</p>
<ul>
<li>generating parsing code from the grammar;</li>
<li>packrat parsing (memoization);</li>
<li>EBNF features like <code>(x | y)</code>, <code>[x y ...]</code>, <code>x*</code>, <code>x+</code>;</li>
<li>tracing (for debugging the <strong>parser</strong> or grammar);</li>
<li><strong>PEG</strong> features like lookahead and “cut”;</li>
<li>how to handling left recursive rules;</li>
<li>generating C code.</li>
</ul>
<p>License for this article and the code shown: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../../../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../../../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>